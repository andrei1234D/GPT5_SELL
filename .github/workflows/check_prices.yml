name: Daily GPT-5 Stock Sell Alert

permissions:
  contents: write
  id-token: write

on:
  schedule:
    - cron: '30 14 * * 1-5'
    - cron: '0,30 15-20 * * 1-5'
    - cron: '0 21 * * 1-5'
  workflow_dispatch:

jobs:
  check-prices:
    runs-on: ubuntu-latest
    env:
      MT_MODELS_BUCKET: gpt5-sell-models-balasandrei-20251221
      MT_MODELS_PREFIX: models
      MT_MODELS_VERSION: '20251221'

    steps:
      - name: Checkout repo (no LFS)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          lfs: false

      - name: Set model path env (SELL_MODEL_DIR)
        shell: bash
        run: |
          echo "SELL_MODEL_DIR=${RUNNER_TEMP}/mt_models" >> "$GITHUB_ENV"
          echo "Using SELL_MODEL_DIR=${RUNNER_TEMP}/mt_models"

      - name: Cache MT models
        uses: actions/cache@v3
        with:
          path: ${{ runner.temp }}/mt_models
          key: mt-models-${{ env.MT_MODELS_VERSION }}
      - name: Show GitHub context (for WIF condition)
        shell: bash
        run: |
          echo "GITHUB_REPOSITORY=${GITHUB_REPOSITORY}"
          echo "GITHUB_REPOSITORY_OWNER=${GITHUB_REPOSITORY_OWNER}"
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "GITHUB_EVENT_NAME=${GITHUB_EVENT_NAME}"
          echo "GITHUB_ACTOR=${GITHUB_ACTOR}"

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Download MT model artifacts from GCS (if not cached)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${SELL_MODEL_DIR}"

          for f in best_model_MT-1.joblib best_model_MT0.joblib best_model_MT1.joblib; do
            if [ ! -s "${SELL_MODEL_DIR}/${f}" ]; then
              echo "Downloading ${f}..."
              gcloud storage cp \
                "gs://${MT_MODELS_BUCKET}/${MT_MODELS_PREFIX}/${f}" \
                "${SELL_MODEL_DIR}/${f}"
            else
              echo "Already present: ${f}"
            fi
          done

          echo "=== Model directory ==="
          ls -lah "${SELL_MODEL_DIR}"

      - name: Set up Git identity
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "bot@github.actions"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

      - name: Build MT dataset (live Yahoo Finance)
        run: |
          python bot/LLM_data/input_llm/prepare_llm_dataset.py

      - name: Run MT predictions
        run: |
          python bot/llm_predict.py

      - name: Run price check + sell logic
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" = "21" ]; then
            python bot/decision_engine.py --endofday
          else
            python bot/decision_engine.py
          fi

      - name: Post-process tracker + PnL gain/loss
        run: |
          python bot/post_process_tracker.py

      - name: Commit and push latest outputs
        run: |
          git add bot/sell_alerts_tracker.json || true
          git add bot/PnL_gain_loss.json || true
          git add bot/live_results.csv || true
          git add bot/LLM_data/input_llm/llm_input_latest.csv || true
          git add bot/LLM_data/input_llm/llm_predictions.csv || true
          git commit -m "ü§ñ Auto-update tracker + MT data [$(date -u '+%Y-%m-%d %H:%M:%S UTC')]" || echo "‚ö†Ô∏è Nothing to commit"
          git pull --rebase || true
          git push || true

  test-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run notify.py
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: python bot/notify.py
